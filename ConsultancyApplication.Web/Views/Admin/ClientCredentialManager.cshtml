@{
    ViewData["Title"] = "Müşteri Hesapları Yönetimi";
}

<div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">🔐 Müşteri Hesapları</h5>
    </div>
    <div class="card-body">

        <!-- ➕ Kayıt Ekleme Alanı -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
            <div class="d-flex gap-2">
                <input type="text" id="inputCompany" class="form-control" placeholder="Firma Adı" style="width: 200px;" />
                <input type="text" id="inputContact" class="form-control" placeholder="Yetkili" style="width: 200px;" />
                <button id="btnAdd" class="btn btn-success">Ekle</button>
            </div>

            <!-- 🔍 Filtre Alanları -->
            <div class="d-flex gap-2">
                <input id="filterCompany" class="form-control form-control-sm" placeholder="Firma" style="width: 140px;" />
                <input id="filterContact" class="form-control form-control-sm" placeholder="Yetkili" style="width: 140px;" />
                <input id="filterPhone" class="form-control form-control-sm" placeholder="Telefon" style="width: 140px;" />
                <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Filtreleri Temizle</button>
            </div>
        </div>

        <div id="client-table"></div>
    </div>
</div>

<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet" />
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<style>
    #client-table {
        height: 500px;
        font-size: 14px;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .tabulator {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background-color: #fff;
    }

        .tabulator .tabulator-header {
            background-color: #6b9c91 !important;
            color: #ffffff !important;
            font-weight: 600;
        }

        .tabulator .tabulator-col,
        .tabulator .tabulator-col-content {
            background-color: #6b9c91 !important;
            color: #ffffff !important;
        }

        .tabulator .tabulator-row {
            background-color: #ffffff !important;
            color: #212529 !important;
            border-bottom: 1px solid #e9ecef;
        }

            .tabulator .tabulator-row:hover {
                background-color: #f6fdf9;
            }

        .tabulator .tabulator-cell {
            padding: 10px 14px;
        }

        .tabulator .tabulator-footer {
            background-color: #f8f9fa;
            color: #6c757d;
        }
</style>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const table = new Tabulator("#client-table", {
                ajaxURL: "/Admin/GetClientCredentials",
                layout: "fitColumns",
                pagination: "local",
                paginationSize: 7,
                responsiveLayout: "collapse",
                placeholder: "Kayıt bulunamadı",
                columns: [
                    { title: "Id", field: "id", visible: false },
                    { title: "Firma Adı", field: "companyName", editor: "input" },
                    { title: "Yetkili", field: "contactPerson", editor: "input" },
                    { title: "Telefon", field: "phoneNumber", editor: "input" },
                    { title: "E-Posta", field: "email", editor: "input" },
                    { title: "Portal Kullanıcı", field: "portalUsername", editor: "input" },
                    { title: "Portal Şifre", field: "portalPassword", editor: "input" },
                    { title: "App Şifre", field: "appPassword", editor: "input" },
                    {
                        title: "Düzenle", formatter: "buttonTick", width: 90, hozAlign: "center",
                        cellClick: function (e, cell) {
                            const updatedData = cell.getRow().getData();
                            fetch('/Admin/UpdateClientCredential', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedData)
                            }).then(res => {
                                if (!res.ok) {
                                    alert("❌ Güncelleme başarısız.");
                                } else {
                                    alert("✅ Güncelleme başarılı.");
                                }
                            }).catch(err => {
                                console.error("⚠️ Güncelleme hatası:", err);
                            });
                        }
                    },
                    {
                        title: "Sil", formatter: "buttonCross", width: 80, hozAlign: "center",
                        cellClick: function (e, cell) {
                            const data = cell.getRow().getData();
                            if (confirm("Bu kaydı silmek istediğinizden emin misiniz?")) {
                                fetch("/Admin/DeleteClientCredential", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ id: data.id })
                                }).then(res => res.json()).then(r => {
                                    if (r.success) {
                                        alert("🗑️ Kayıt başarıyla silindi.");
                                        cell.getRow().delete();
                                    } else {
                                        alert("❌ Silme başarısız.");
                                    }
                                }).catch(err => {
                                    console.error("⚠️ Silme hatası:", err);
                                    alert("⚠️ Hata oluştu.");
                                });
                            }
                        }
                    }
                ]
            });

            // 🔍 Filtre alanları
            document.getElementById("filterCompany").addEventListener("input", function () {
                table.setFilter("companyName", "like", this.value);
            });

            document.getElementById("filterContact").addEventListener("input", function () {
                table.setFilter("contactPerson", "like", this.value);
            });

            document.getElementById("filterPhone").addEventListener("input", function () {
                table.setFilter("phoneNumber", "like", this.value);
            });

            document.getElementById("clearFilters").addEventListener("click", function () {
                document.getElementById("filterCompany").value = "";
                document.getElementById("filterContact").value = "";
                document.getElementById("filterPhone").value = "";
                table.clearFilter();
            });

            // ➕ Yeni kayıt
            document.getElementById("btnAdd").addEventListener("click", function () {
                const company = document.getElementById("inputCompany").value;
                const contact = document.getElementById("inputContact").value;

                if (company && contact) {
                    const newData = {
                        companyName: company,
                        contactPerson: contact,
                        phoneNumber: "",
                        email: "",
                        portalUsername: "",
                        portalPassword: "",
                        appPassword: ""
                    };

                    fetch("/Admin/AddClientCredential", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newData)
                    }).then(res => res.json()).then(result => {
                        if (result.success) {
                            table.addRow(result.data);
                            document.getElementById("inputCompany").value = "";
                            document.getElementById("inputContact").value = "";
                            console.log("➕ Yeni kayıt eklendi:", result.data);
                        } else {
                            alert("❌ Kayıt eklenemedi");
                        }
                    });
                } else {
                    alert("⚠️ Lütfen Firma ve Yetkili giriniz.");
                }
            });
        });
    </script>
}
